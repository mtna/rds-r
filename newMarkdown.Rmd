---
title: "Selecting and Tabulating Data with Rich Data Services"
output:
  html_document
---

##Overview
Access data and metadata together in one quick call, with Rich Data Services (RDS) there is no need to search for documentation or to transcribe it into R. Documentation is provided to users along side the data through the same API call. Variable and classification metadata can accompany any data that is queried through RDS through the use of a few simple parameters.

In this document we will be using data from the American National Election Study 1948 (ANES) that is stored on MTNA's public RDS server. 

##Install
The following packages will be needed for this demonstration.
```{r install,eval=FALSE}
install.packages("rds.r")
install.packages("htmlTable")
install.packages(sjPlot)
install.packages(ggplot2)
install.packages(plyr)
```
```{r libraries, eval=TRUE, tidy=TRUE, tidy.opts=list(width.cutoff=80), message=FALSE}
library(rds.r)
library(htmlTable)
library(sjPlot)
library(ggplot2)
library(plyr)
```

##Why RDS?
Traditionally when researchers want to analyze data that is not their own they will have to complete several tasks before they can start their research. 

* Locate the data set they want to work with
* Acquire the data and load it in R
* Access the documentation and transcribe the documentation into a useful format in R

RDS cuts down the time it takes for reasearchers to locate and access the data of interest in a particular data set through its innovative querying capabilities and the metadata that can accompany every query.

##Querying data
Lets imagine that we are researching the United States presidential election from 1948, between Harry Truman, and Thomas Dewey. We are interested in demographic data of the respondent and why they did or did not vote for Harry Truman. We may take a look at the documentation on the ANES website https://electionstudies.org/wp-content/uploads/1948/03/anes_timeseries_1948vardoc_codebook.pdf which has a lot of good information about the variables and their codes presented in an ASCII format. However, to identify the variables of interest we would need to read through all 67 variables and their names and labels and choose the variables that have to do with respondent demographics or questions about Truman.

RDS will save you the trouble, instead of manually reading the variables information, we can request the variables and their metadata be returned to us by searching for keywords. This will return more than data, the variable and classification metadata will be available as well. This will allow us to document the variables we are using to provide ourselves and others with more context around the data we are using. 

For the purposes of this example we will use the "select" function with keyword parameters to only get columns containing "truman" or "respondent", as we are interested in the respondents and how they answered questions about Truman.
```{r querying-data, eval = TRUE, results = 'hide', tidy=TRUE, tidy.opts=list(width.cutoff=80)}
# We use the select function to hit the anes/anes1948 data product and look for cols with the keywords truman and respondent. Metadata is set to true so we can see the variables metadata, and we set row limit to 10 to keep this example short.
dataSet <- select("http://localhost:8080/rds/api/query/", "anes", "anes1948", cols="$truman,$respondent", metadata=TRUE, rowLimit=10, autoPage=FALSE)

# get the variable metadata from the data set that was returned and display it in a table.
#variablesMetadata <- get.variables("http://localhost:8080/rds/api/catalog/","anes","anes1948",cols="$truman,$respondent",columnLimit=10)
vars <- dataSet@variables
varTable<-htmlTable(vars,col.rgroup = c("none", "#F7F7F7"),css.table="width: 100%; ", css.cell = "padding-left: 2%; padding-right: 2%; font-family:\"Helvetica Neue\",Helvetica,Arial,sans-serif; font-size:14px", rnames=FALSE)

# get the data from the data set and display it in a table
data <- dataSet@data
dataTable<-htmlTable(data,col.rgroup = c("none", "#F7F7F7"),css.table="width: 100%;", css.cell = "padding-left: 2%; padding-right: 2%;font-family:\"Helvetica Neue\",Helvetica,Arial,sans-serif; font-size:14px", rnames=FALSE)
```
###Dictionary
`r varTable`

###Data
`r dataTable`

###Data With Code Values
Maybe we want to know the code values for the codes of one or more of these variables, we have two options to do this. 

First we could inject the code values into the returned data set as using the **inject** parameter.
```{r data-with-code-values, eval = TRUE, results = 'hide', tidy=TRUE, tidy.opts=list(width.cutoff=80)}
#took out colLimit=10
dataSet <- select("http://localhost:8080/rds/api/query/","anes","anes1948", colLimit=10, rowLimit = 10, metadata = TRUE, inject=TRUE)
data <- dataSet@data
#TODO this is wonky, doesn't work when colLimit=10 is on, but not including it makes a weird table
dataTable<-htmlTable(data,col.rgroup = c("none", "#F7F7F7"), css.table="width: 100%;",css.cell = "padding-left: 2%; padding-right: 2%; font-family:\"Helvetica Neue\",Helvetica,Arial,sans-serif; font-size:14px", rnames=FALSE)
```
`r dataTable`

###Sex of Respondent: Classification
We could also simply access the classification information for a given variable. We will take the classification URI from the "Sex of Respondent" variable and get teh classification for it. 
```{r classifications, eval = TRUE, results = 'hide', tidy=TRUE, tidy.opts=list(width.cutoff=80)}
V480045 <- rds.r:::variable(dataSet@variables,"V480045")
classification <- rds.r::get.classification("http://localhost:8080/rds/api/catalog/","anes","anes1948",class.id=V480045$classificationUri)
classTable<-htmlTable(classification, col.rgroup = c("none", "#F7F7F7"),css.table="width: 100%;", rnames=FALSE)
```
`r classTable`

##Tabulating Data
Perhaps we would like to know if there is any difference between why male and female respondents think people voted for Truman. First lets create the table using the **tabulate** function.
```{r tabulation, eval = TRUE, results = 'hide', tidy=TRUE, tidy.opts=list(width.cutoff=80)}
tabulation <- rds.r::tabulate("http://localhost:8080/rds/api/query/","anes","anes1948", metadata=TRUE,dimensions="V480045,V480014a", inject=TRUE)
data <- tabulation@data
variables<-tabulation@variables
variableNames <- list();
variableNames<-variables$label
table<- sjtable<- sjt.xtab(data$V480045, data$V480014a,var.labels=variableNames)

```
`r table`

##Turning Tabulations into Charts
Because the tabulate function returns a data set that contains the data and metadata, all we need to do is plug in the appropriate data and metadata into our favorite charting tool. 
```{r tabulations-to-charts, eval = TRUE, results = 'hide', tidy=TRUE, tidy.opts=list(width.cutoff=80),fig.width=12, fig.height=10}
variables <- tabulation@variables
V480045 <- rds.r:::variable(variables,"V480045")
V480014a <- rds.r:::variable(variables,"V480014a")

## we will compute the percentage and format it as a percentage label for the chart
data$count<-as.numeric(as.character(data$count))
data = ddply(data, .(V480014a), transform, Pct = count/sum(count) * 100)
data = ddply(data, .(V480014a), transform, pos = (cumsum(count) - 0.5 * count))
data$label = paste0(sprintf("%.0f", data$Pct), "%")

#plot the data
ggplot(data, aes(x = factor(V480014a), y = count, fill = V480045)) +
geom_bar(stat = "identity") +
geom_text(aes(y = pos, label = label), size = 3) +
theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),axis.text.y=element_text(size=12), legend.position="top")+
xlab(V480014a$label)+
coord_flip()
```

<br/><br/><br/><br/>
