install.packages("ggplot2")
install.packages("devtools")
install("/Users/carsonhuntermtna/R/development/rds-r")
library("ggplot2")
library("devtools")
library("rds.r")

#select. Metadata and data being returned together. 
?rds.r::select
#TODO not grabbing classifications
dataSet <- select("http://localhost:8080/rds/api/query/","anes","anes1948aws")
data <- dataSet@data
variables <- dataSet@variables
info <- dataSet@info
classifications <- dataSet@classifications
rm(data,dataSet,variables,info,classifications)

dataSet <- select("http://localhost:8080/rds/api/query/","anes","anes1948aws",autoPage=FALSE)
data <- dataSet@data
variables <- dataSet@variables
rm(data,dataSet,variables)

dataSet <- select("http://localhost:8080/rds/api/query/","anes","anes1948aws",inject=TRUE)
data <- dataSet@data
variables <- dataSet@variables
rm(data,dataSet,variables)

#DISTINCT - not yet implemented
#query: [1] "http://localhost:8080/rds/api/query/anes/anes1948aws/select?metadata=true&cols=$truman&where=V480003=1&orderby=V480045%2cV480047%20DESC&distinct"
#dataSet <- select("http://localhost:8080/rds/api/query/","anes","anes1948aws",cols="$truman",where="V480003=1",orderby="V480045,V480047 DESC",distinct=TRUE)
dataSet <- select("http://localhost:8080/rds/api/query/","anes","anes1948aws",cols="$respondent",where="V480003=1",orderby="V480045,V480047 DESC", distinct=TRUE)
data <- dataSet@data
variables <- dataSet@variables
rm(data,dataSet,variables)

#distinct not a valid param yet
#dataSet <- select("http://localhost:8080/rds/api/query/","anes","anes1948aws",cols="$respondent",where="V480003=1",orderby="V480045,V480047 DESC",distinct=TRUE,inject=TRUE)
dataSet <- select("http://localhost:8080/rds/api/query/","anes","anes1948aws",cols="$respondent",where="V480003=1",orderby="V480045,V480047 DESC",distinct=FALSE,inject=FALSE)
data <- dataSet@data
variables <- dataSet@variables
rm(data,dataSet,variables)

#get the metdata returned with the data and use the methods to access var and class metadata
dataSet <- select("http://localhost:8080/rds/api/query/","anes","anes1948aws",cols="$respondent",where="V480003=1",orderby="V480045,V480047 DESC",distinct=FALSE,inject=FALSE)
variables<-dataSet@variables
var <- rds.r:::variable(variables,"V480006")
rm(data,dataSet,variables,var)

#query multiple classifications' metadata
?get.classification
classificationsMetadata <- get.classifications("http://localhost:8080/rds/api/catalog/","anes","anes1948aws")
classifications <- new("rds.classifications",json=classificationsMetadata)
newclassifications <- rds.r:::classifications(classifications)
rm(classificationsMetadata,classifications,newclassifications)

#select a single classifications metadata
?get.classification
#TODO can't get this bc variable doesn't have classifId on it
#class <- rds.r:::classification(classificationsMetadata, var$classificationId)
class <- rds.r:::classification(classificationsMetadata, "V480006")
id <- class@id
codes <- class@codes

#TODO make a function to get codes
#tabulations
?rds.r::tabulate
dataSet <- rds.r::tabulate("http://localhost:8080/rds/api/query/","anes","anes1948aws",dimensions="V480003", inject=TRUE)
data<-dataSet@data
variables<-dataSet@variables
V480003<-rds.r:::variable(variables,"V480003")

#plot v480003 var
ggplot(data, aes(x = factor(data$V480003), y = data$count)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=12),axis.text.y=element_text(size=12),legend.position="top")+
  xlab(V480003$label)+
  coord_flip()

#select a single variables' metadata
?get.variable
varMetadata <- get.variable("http://localhost:8080/rds/api/catalog/","anes","anes1948aws",var.id="V480003")

#query variable metadata for multiple variables metadata
?get.variables
variablesMetadata <- get.variables("http://localhost:8080/rds/api/catalog/","anes","anes1948aws",cols="$respondent")

#injecting metadata
dataSet <- select("http://localhost:8080/rds/api/query/","anes","anes1948aws",inject=TRUE)
data<-dataSet@data


dataSet <- select("http://localhost:8080/rds/api/query/","anes","anes1948aws",autoPage=FALSE)
data <- dataSet@data
dataTable <- sjPlot::tab_df(data, use.viewer = F, encoding = "UTF-8", alternate.rows=TRUE, show.rownames=FALSE)$knitr
print(dataTable)
extr <- sjPlot::tab_df(data, use.viewer= T, encoding="UTF-8", alternate.rows = TRUE, show.rownames = FALSE)$knitr
print(ex)


# Variable information
variables <- dataSet@variables
list <- variables@json
# format the data and ensure the variable names are used as colnames in the data.frame 
newDf <- data.frame(variables)
jtable <- sjPlot::tab_df(variablesMetadata)
print(jtable)

vdf <- data.frame(variables@json)
variableNames <- list();
for(variable in variables@json){
  id    <- variable$id
  variableNames <- c(variableNames, id)
}
colnames(vdf)<-variableNames

data <- data.frame(dataSet@data)
variableNames <- list();
for(variable in variables@json){
  id    <- variable$id
  variableNames <- c(variableNames, id)
}
colnames(data)<-variableNames
rmarkdown::render("R/development/rds-r/examples.R")

dataTable <- sjPlot::tab_df(data, use.viewer = F, encoding = "UTF-8", alternate.rows=TRUE, show.rownames=FALSE)
print(dataTable)

devtools::install_github("jeffjjohnston/RStudioConsoleRender")
rmarkdown::render(active_document_path, envir=.GlobalEnv)